<!doctype html>
<html>
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin Editor</title>
  <style>body{font-family:Arial;padding:1rem}.row{display:flex;gap:1rem}.col{flex:1}</style>
</head>
<body>
  <h1>Editor</h1>
  <div>
    <button id="signout">Sign out</button>
  </div>
  <div class="row">
    <div class="col">
      <h3>content.json</h3>
      <textarea id="json" style="width:100%;height:400px;font-family:monospace"></textarea>
      <div style="margin-top:.5rem">
        <button id="save">Save</button>
        <span id="status"></span>
      </div>
    </div>
    <div class="col">
      <h3>Upload Image</h3>
      <input type="file" id="file"><button id="upload">Upload</button>
      <div id="uploads"></div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem('vd_token');
    if(!token) location.href='/admin/login.html';
    document.getElementById('signout').addEventListener('click',()=>{localStorage.removeItem('vd_token');location.href='/admin/login.html'});

    async function load(){
      const r=await fetch('/api/content'); const data=await r.json(); document.getElementById('json').value=JSON.stringify(data,null,2);
    }
    load();

    document.getElementById('save').addEventListener('click',async ()=>{
      const txt=document.getElementById('json').value; let json;
      try{json=JSON.parse(txt);}catch(e){alert('Invalid JSON');return}
      document.getElementById('status').textContent='Saving...';
      const res=await fetch('/api/save',{method:'POST',headers:{'content-type':'application/json','authorization':'Bearer '+token},body:JSON.stringify({content:json})});
      if(res.ok){document.getElementById('status').textContent='Saved';setTimeout(()=>document.getElementById('status').textContent='',2000)}else{document.getElementById('status').textContent='Error'}
    });

    document.getElementById('upload').addEventListener('click',async ()=>{
      const f=document.getElementById('file').files[0]; if(!f) return alert('Select file');
      const reader=new FileReader(); reader.onload=async ()=>{
        const b=reader.result.split(',')[1];
        const res=await fetch('/api/upload',{method:'POST',headers:{'content-type':'application/json','authorization':'Bearer '+token},body:JSON.stringify({name:f.name,content:b})});
        const j=await res.json(); if(res.ok){const el=document.createElement('div');el.textContent='Uploaded: '+j.path;document.getElementById('uploads').appendChild(el)}else{alert('Upload failed')}
      }; reader.readAsDataURL(f);
    });
  </script>
</body>
</html>
